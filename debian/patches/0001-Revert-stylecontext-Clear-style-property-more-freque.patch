From fb803ef386d1fe0da96eb57b5ce19ca90a3d360d Mon Sep 17 00:00:00 2001
From: Andreas Henriksson <andreas@fatal.se>
Date: Sat, 10 Oct 2015 17:29:44 +0200
Subject: [PATCH] Revert "stylecontext: Clear style property more frequently"

This reverts commit 3e5280ae4dfd1950dbd56a781dcdcf34a26d4294.

https://bugzilla.gnome.org/show_bug.cgi?id=756338
https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=800911

---
 gtk/gtkcsswidgetnode.c       | 19 -------------------
 gtk/gtkstylecontext.c        |  4 +++-
 gtk/gtkstylecontextprivate.h |  1 -
 3 files changed, 3 insertions(+), 21 deletions(-)

diff --git a/gtk/gtkcsswidgetnode.c b/gtk/gtkcsswidgetnode.c
index 5e93101..fbd9fbb 100644
--- a/gtk/gtkcsswidgetnode.c
+++ b/gtk/gtkcsswidgetnode.c
@@ -74,24 +74,6 @@ gtk_css_widget_node_queue_callback (GtkWidget     *widget,
   return G_SOURCE_CONTINUE;
 }
 
-static GtkCssStyle *
-gtk_css_widget_node_update_style (GtkCssNode   *cssnode,
-                                  GtkCssChange  change,
-                                  gint64        timestamp,
-                                  GtkCssStyle  *style)
-{
-  GtkCssWidgetNode *widget_node = GTK_CSS_WIDGET_NODE (cssnode);
-
-  if (widget_node->widget != NULL)
-    {
-      GtkStyleContext *context = _gtk_widget_peek_style_context (widget_node->widget);
-      if (context)
-        gtk_style_context_clear_property_cache (context);
-    }
-
-  return GTK_CSS_NODE_CLASS (gtk_css_widget_node_parent_class)->update_style (cssnode, change, timestamp, style);
-}
-
 static void
 gtk_css_widget_node_queue_validate (GtkCssNode *node)
 {
@@ -271,7 +253,6 @@ gtk_css_widget_node_class_init (GtkCssWidgetNodeClass *klass)
   GObjectClass *object_class = G_OBJECT_CLASS (klass);
 
   object_class->finalize = gtk_css_widget_node_finalize;
-  node_class->update_style = gtk_css_widget_node_update_style;
   node_class->validate = gtk_css_widget_node_validate;
   node_class->queue_validate = gtk_css_widget_node_queue_validate;
   node_class->dequeue_validate = gtk_css_widget_node_dequeue_validate;
diff --git a/gtk/gtkstylecontext.c b/gtk/gtkstylecontext.c
index 9a5587d..c658cff 100644
--- a/gtk/gtkstylecontext.c
+++ b/gtk/gtkstylecontext.c
@@ -257,7 +257,7 @@ gtk_style_context_class_init (GtkStyleContextClass *klass)
   g_object_class_install_properties (object_class, LAST_PROP, properties);
 }
 
-void
+static void
 gtk_style_context_clear_property_cache (GtkStyleContext *context)
 {
   GtkStyleContextPrivate *priv = context->priv;
@@ -2422,6 +2422,8 @@ gtk_style_context_validate (GtkStyleContext  *context,
 {
   if (!_gtk_bitmask_is_empty (changes))
     gtk_style_context_do_invalidate (context, changes);
+
+  gtk_style_context_clear_property_cache (context);
 }
 
 /**
diff --git a/gtk/gtkstylecontextprivate.h b/gtk/gtkstylecontextprivate.h
index 4ba27fe..c1faaba 100644
--- a/gtk/gtkstylecontextprivate.h
+++ b/gtk/gtkstylecontextprivate.h
@@ -47,7 +47,6 @@ const GValue * _gtk_style_context_peek_style_property        (GtkStyleContext *c
                                                               GParamSpec      *pspec);
 void            gtk_style_context_validate                   (GtkStyleContext *context,
                                                               const GtkBitmask*changes);
-void            gtk_style_context_clear_property_cache       (GtkStyleContext *context);
 gboolean       _gtk_style_context_check_region_name          (const gchar     *str);
 
 gboolean       _gtk_style_context_resolve_color              (GtkStyleContext    *context,
-- 
2.6.1

